import { ConfigManager } from "../core/config";
import { Agent } from "@mariozechner/pi-agent-core";
import { getModel } from "@mariozechner/pi-ai";

export interface AgentConfig {
  name: string;
  provider: string;
  model: string;
  systemPrompt?: string;
  thinkingLevel?: "off" | "minimal" | "low" | "medium" | "high" | "xhigh";
}

export class AgentManager {
  private agents: Map<string, Agent> = new Map();
  private mainAgent!: Agent;

  async init() {
    const mainModel = await ConfigManager.get<string>("agents.main.model", "claude-3.5-sonnet");
    const mainProvider = await ConfigManager.get<string>("agents.main.provider", "anthropic");
    const mainSystemPrompt = await ConfigManager.get<string>(
      "agents.main.systemPrompt",
      "You are a helpful assistant for job hunting tasks."
    );

    this.mainAgent = new Agent({
      initialState: {
        systemPrompt: mainSystemPrompt,
        model: getModel(mainProvider as any, mainModel as any),
      },
    });

    const enabledAgents = await ConfigManager.get<AgentConfig[]>("agents.enabled", []) || [];

    console.log(`Initializing ${enabledAgents.length} sub-agents...`);

    for (const config of enabledAgents) {
      try {
        const agent = new Agent({
          initialState: {
            systemPrompt: config.systemPrompt || "You are a specialized assistant.",
            model: getModel(config.provider as any, config.model as any),
          },
        });

        this.agents.set(config.name, agent);
        console.log(`  Registered: ${config.name} (${config.provider}/${config.model})`);
      } catch (e) {
        console.error(`  Failed to register ${config.name}:`, e);
      }
    }

    if (enabledAgents.length === 0) {
      console.log("No sub-agents configured, main agent will handle all tasks");
    }
  }

  getAgent(name?: string): Agent {
    if (name && this.agents.has(name)) {
      return console.log(`Routing to: ${name}`), this.agents.get(name)!;
    }
    return console.log("Using main agent"), this.mainAgent;
  }

  async prompt(agentName: string | undefined, text: string): Promise<string> {
    const agent = this.getAgent(agentName);
    let fullResponse = "";
    let eventCount = 0;
    const MAX_EVENTS = 1000;

    try {
      for await (const event of agent.prompt(text)) {
        eventCount++;
        if (eventCount > MAX_EVENTS) {
          console.warn("Too many events, breaking");
          break;
        }

        if (event.type === "message_update" && (event as any).assistantMessageEvent?.type === "text_delta") {
          fullResponse += (event as any).assistantMessageEvent.delta;
        }
      }
    } catch (e) {
      console.error("Agent prompt error:", e);
    }

    return fullResponse;
  }
}
